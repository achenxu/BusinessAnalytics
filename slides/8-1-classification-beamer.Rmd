---
title: 'ETC3250 Business Analytics: Classification'
author: "Souhaib Ben Taieb, Di Cook, Rob Hyndman"
date: "August 31, 2015"
output:
  beamer_presentation: 
    theme: Monash
---

## What is classification?

- Supervised classification includes multivariate techniques finding a rule for separating observations/cases into known classes, and using this rule to classify new observations.
- The process starts with a training sample, that is the full data set with known classes. Typically the variables that will be used to generate the classification rule are easy/cheap to measure, but the class is more difficult to measure. It is important to be able to classify new observations using variables that are easy to measure.

## Supervised vs Unsupervised

Unsupervised classification, also called cluster analysis, differs from supervised in that the classes are not known ahead of time, and need to be discovered first and labelled. 

```{r fleaplots, cache=FALSE, echo=FALSE, warning=FALSE, message=FALSE, fig.show='hold', fig.height=2.5, fig.width=2.5}
library(ggplot2)
library(tourr)
library(dplyr)

data(flea)
qplot(tars1, aede1, data=flea, color=species) + 
  theme(aspect.ratio=1, legend.position="none") + xlab("") + ylab("")
qplot(tars1, aede1, data=flea) + theme(aspect.ratio=1) + xlab("") + ylab("")
```

## Example 1: Olive oils

\begin{tabular}{cp{3in}}
\includegraphics[height=2in]{../figures/Italian-olive-oils-map.png}
&
\vspace{-2in}
\begin{itemize}
\item Example data: Fatty acid composition of Italian olive oils. 
\item Three growing regions: labelled 1, 2, 3 (class variable)
\item 8 fatty acids, \% in the sample x 100. 
\end{itemize}
\end{tabular}

## Question

- Two variables shown. How would you draw boundaries, so that if you received a new assayed sample you would be able to confidently predict which region produced the oil? 

```{r olives, cache=FALSE, echo=FALSE, warning=FALSE, error=FALSE, message=FALSE, fig.height=4.5, fig.width=4.5}
data(olive)
olive$region <- factor(olive$region, labels=c("South", "Sardinia", "North"))
qplot(eicosenoic, linoleic, data=olive, color=region, shape=region, alpha=I(0.8)) +
  theme(aspect.ratio=1)
```

## Example 2: Beetles

\begin{tabular}{p{1.5in}p{3in}}
\includegraphics[height=1in]{../figures/beetle.jpg}

{\tiny (Copyright 2005 Jim McClarin)}
&
\vspace{-1in}
\begin{itemize}
\item Example data: Beetles 
\item 3 species (class variable)
\item 6 physical measurements
\end{itemize}
\end{tabular}

## Question

- Two variables shown. How would you draw boundaries, so that if you found a new specimen you would be able to confidently predict the species? 

```{r flea, cache=FALSE, echo=FALSE, warning=FALSE, error=FALSE, message=FALSE, fig.height=4.5, fig.width=4.5}
qplot(tars1, aede1, data=flea, color=species, shape=species) + 
  theme(aspect.ratio=1) 
```

## Example 3: Australian crabs

\begin{tabular}{p{1.5in}p{3in}}
\includegraphics[height=1in]{../figures/crab.jpg}

{\tiny (Andrei Nikulinsky @clusterpod)}
&
\vspace{-1in}
\begin{itemize}
\item Example data: Crabs 
\item 2 species, 2 sexes (class variable)
\item 5 physical measurements
\end{itemize}
\end{tabular}

## Question

- Two variables shown. How would you draw boundaries, so that if you found a new specimen you would be able to confidently predict two sexes? 

```{r crab, cache=FALSE, echo=FALSE, warning=FALSE, error=FALSE, message=FALSE, fig.height=4.5, fig.width=4.5}
crab <- read.csv("http://www.ggobi.org/book/data/australian-crabs.csv")
crab <- subset(crab, species=="Blue", select=c("sex", "FL", "RW"))
qplot(FL, RW, data=crab, color=sex, shape=sex) + 
  theme(aspect.ratio=1) 
```

## Simple approach

- Calculate the mean of each class
- Calculate the distance between the new observation and each of the means
- Predict the new observation into the class of the closest mean

## Boundaries for Olive oils  

```{r oliveslda, echo=FALSE, warning=FALSE, error=FALSE, message=FALSE, fig.height=5, fig.width=5}
olive.p <- data.frame(expand.grid(eicosenoic = seq(0, 60, 1), linoleic = seq(440, 1500, 10)))
library(MASS)
olive.lda <- lda(region~eicosenoic+linoleic, data=olive, 
                 prior=c(0.34, 0.33, 0.33))
olive.p$region <- predict(olive.lda, olive.p)$class
ol.m <- summarise(group_by(olive, region), eicosenoic=mean(eicosenoic),
                  linoleic=mean(linoleic))
qplot(eicosenoic, linoleic, data=olive.p, color=region, alpha=I(0.2)) +
  geom_point(data=olive, aes(shape=region)) + 
  geom_point(data=ol.m, shape=3, size=5, color="black") +
  theme_bw() + theme(aspect.ratio=1)
```

## Boundaries for Beetles  

```{r flealda, echo=FALSE, warning=FALSE, error=FALSE, message=FALSE, fig.height=5, fig.width=5}
flea.p <- data.frame(expand.grid(tars1 = seq(120, 250, 1), aede1 = seq(110, 160, 1)))
flea.lda <- lda(species~tars1+aede1, data=flea, 
                 prior=c(0.34, 0.33, 0.33))
flea.p$species <- predict(flea.lda, flea.p)$class
fl.m <- summarise(group_by(flea, species), tars1=mean(tars1),
                  aede1=mean(aede1))
qplot(tars1, aede1, data=flea.p, color=species, alpha=I(0.2)) +
  geom_point(data=flea, aes(shape=species)) + 
  geom_point(data=fl.m, shape=3, size=5, color="black") +
  theme_bw() + theme(aspect.ratio=1)
```

## Boundaries for Crabs  

```{r crablda, echo=FALSE, warning=FALSE, error=FALSE, message=FALSE, fig.height=5, fig.width=5}
crab.p <- data.frame(expand.grid(FL = seq(7, 23.5, 0.2), RW = seq(6.3, 20.5, 0.2)))
crab.lda <- lda(sex~FL+RW, data=crab, 
                 prior=c(0.5, 0.5))
crab.p$sex <- predict(crab.lda, crab.p)$class
cr.m <- summarise(group_by(crab, sex), FL=mean(FL),
                  RW=mean(RW))
qplot(FL, RW, data=crab.p, color=sex, alpha=I(0.2)) +
  geom_point(data=crab, aes(shape=sex)) + 
  geom_point(data=cr.m, shape=3, size=5, color="black") +
  theme_bw() + theme(aspect.ratio=1)
```

## YOUR TURN

- How close do the LDA boundaries match what you designed?
- What is different? 
- Why does it differ?

## LDA Rule for TWO groups, ONE variable

This method is called *linear discriminant analysis* (LDA). If there is only ONE VARIABLE and TWO GROUPS, then the LDA Rule would be: 

*For a new observation, $x_0$, assign it to group 2 if* 

\[
x_0 - \frac{\bar{x}_1 + \bar{x}_2}{2} \geq 0 ~~~( ~OR ~x_0 \geq \frac{\bar{x}_1 + \bar{x}_2}{2})
\]

*otherwise assign it to group 1.* 

This assumes that group 1 has the smaller mean.


## Example: olive oils

\begin{itemize}
\item One variable, two groups
\item Where does the boundary go?
\end{itemize}

```{r lda-olive, cache=FALSE, echo=FALSE, warning=FALSE, error=FALSE, message=FALSE, fig.height=4, fig.width=4, fig.align="right"}
olive.sub <- subset(olive, region != "South")
olive.sub$region <- factor(olive.sub$region)
qplot(linoleic, data=olive.sub, fill=region, color=region, 
      geom="density", alpha=I(0.5)) +
  theme_bw() + theme(legend.position="bottom", aspect.ratio=1)
```

## LDA Rule

```{r lda-olive2, cache=FALSE, echo=FALSE, warning=FALSE, error=FALSE}
olive.lda <- lda(region~linoleic, data=olive.sub, 
                 prior=c(0.5, 0.5))
olive.lda$means
```

$\frac{\bar{x}_1 + \bar{x}_2}{2}$ = `r sum(olive.lda$means)/2`

- What is the rule?? 
- To what group would a sample with 10.5% linoleic acid belong?
- What about a sample with 7.5% linoleic acid content?

## LDA Boundary

```{r lda-olive3, cache=FALSE, echo=FALSE, warning=FALSE, error=FALSE, message=FALSE, fig.height=4, fig.width=4}
qplot(linoleic, data=olive.sub, fill=region, color=region, 
      geom="density", alpha=I(0.5)) +
  geom_vline(xintercept=961.78) +
  theme_bw() + theme(legend.position="bottom", aspect.ratio=1)
```

## Example: crabs

\begin{itemize}
\item One variable (ratio of FL and RW), two sexes
\item Where does the boundary go?
\end{itemize}

```{r lda-crab, cache=FALSE, echo=FALSE, warning=FALSE, error=FALSE, message=FALSE, fig.height=4, fig.width=4, fig.align="right"}
#crab$FL.RW <- 3.01*crab$FL -3.86*crab$RW
crab$FL.RW <- crab$FL/crab$RW
qplot(FL.RW, data=crab, fill=sex, color=sex, 
      geom="density", alpha=I(0.5)) +
  theme_bw() + theme(legend.position="bottom", aspect.ratio=1)
```

## LDA Rule

```{r lda-crab2, cache=FALSE, echo=FALSE, warning=FALSE, error=FALSE}
crab.lda <- lda(sex~FL.RW, data=crab, 
                 prior=c(0.5, 0.5))
crab.lda$means
```

$\frac{\bar{x}_1 + \bar{x}_2}{2}$ = `r sum(crab.lda$means)/2`

- What is the rule?? 

## LDA Boundary

```{r lda-crab3, cache=FALSE, echo=FALSE, warning=FALSE, error=FALSE, message=FALSE, fig.height=4, fig.width=4}
qplot(FL.RW, data=crab, fill=sex, color=sex, 
      geom="density", alpha=I(0.5)) +
  geom_vline(xintercept=1.22) +
  theme_bw() + theme(legend.position="bottom", aspect.ratio=1)
```

## Theory

In a perfect world, if we assume we have two samples from two normal distributions with different means but same variance, then the LDA rule is exactly perfect. 

```{r lda-normal, cache=FALSE, echo=FALSE, warning=FALSE, error=FALSE, message=FALSE, fig.height=2.5, fig.width=4.5}
library(mvtnorm)
df <- data.frame(x=c(seq(-5, 5, 0.1), seq(-5, 5, 0.1)), 
  y=c(dnorm(seq(-5, 5, 0.1), mean=-2), dnorm(seq(-5, 5, 0.1), mean=2)), 
      cl=c(rep("A", 101), rep("B",101)))
qplot(x, y, data=df, geom="line", colour=cl) +
  geom_vline(xintercept=0) +
  theme_bw()
```

## More than one variable, only two groups

- With two groups project the data into 1D, and then compute means and compare

*For a new observation, $x_0$, assign it to group 2 if* 

\[
(\bar{x}_1-\bar{x}_2)^TS_p^{-1}(x_0 - \frac{\bar{x}_1 + \bar{x}_2}{2}) \geq 0
\]

*otherwise assign it to group 1.* 

$S_p$ is the pooled variance-covariance matrix.

## Let's do it

```{r crab-calc1, cache=FALSE, echo=FALSE, warning=FALSE, error=FALSE, message=FALSE, fig.height=5, fig.width=5}
crab <- crab[,-4]
crab$sex <- factor(crab$sex, levels=c("Male", "Female"))
qplot(FL, RW, data=crab, color=sex, shape=sex) + 
  theme(aspect.ratio=1) 
```

## Summary statistics

```{r crab-calc2, cache=FALSE, echo=FALSE, warning=FALSE, error=FALSE, message=FALSE}
options(digits=3)
c_m <- summarise(group_by(crab, sex), FL=mean(FL), RW=mean(RW))
c_m
s1 <- var(crab[crab$sex=="Male",-1])
s2 <- var(crab[crab$sex=="Female",-1])
s1
s2
```

## Pooled variance-covariance

$$S_p = \frac{(n_1-1)S_1}{n_1+n_2-2}+\frac{(n_2-1)S_2}{n_1+n_2-2}$$

$S_p=$
```{r crab-calc3, cache=FALSE, echo=FALSE, warning=FALSE, error=FALSE, message=FALSE}
sp <- (49*s1 + 49*s2)/(98)
sp
```

$S_p^{-1}=$
```{r crab-calc4, cache=FALSE, echo=FALSE, warning=FALSE, error=FALSE, message=FALSE}
spi <- 1/(sp[1,1]*sp[2,2]-sp[1,2]*sp[2,1]) * matrix(c(sp[2,2], -sp[1,2], -sp[2,1], sp[1,1]), ncol=2)
spi
```

## Linear combination

$(\bar{x}_1-\bar{x}_2)^TS_p^{-1}=$
```{r crab-calc5, cache=FALSE, echo=FALSE, warning=FALSE, error=FALSE, message=FALSE}
proj <- as.matrix((c_m[1,-1]-c_m[2,-1]))%*%spi
proj
```

New variable: `r proj[1]`xFL`r proj[2]`xRW

Low-dimensional space (discriminant space): `r proj[1]`xFL`r proj[2]`xRW=0

## Plot it - discriminant space

```{r crab-calc6, cache=FALSE, echo=FALSE, warning=FALSE, error=FALSE, message=FALSE, fig.height=5, fig.width=5}
qplot(FL, RW, data=crab, color=sex, shape=sex) + 
  geom_abline(intercept=30, slope=-1.26) + 
  theme(aspect.ratio=1) 
```

## Plot it - discriminant space

```{r crab-calc6b, cache=FALSE, echo=FALSE, warning=FALSE, error=FALSE, message=FALSE, fig.height=5, fig.width=5}
crab$d1 <- 3.07*crab$FL - 3.86*crab$RW
qplot(d1, data=crab, geom="histogram", fill=sex) + facet_wrap(~sex, ncol=1) 
```

## Plot it - boundary

```{r crab-calc7, cache=FALSE, echo=FALSE, warning=FALSE, error=FALSE, message=FALSE, fig.height=5, fig.width=5}
qplot(FL, RW, data=crab, color=sex, shape=sex) + 
  geom_abline(intercept=30, slope=-1.26, linetype=2) + 
  geom_abline(intercept=0.753, slope=0.795) + 
  theme(aspect.ratio=1) 
```

## ???

These lines are orthogonal !!!

## Plot it - boundary

```{r crab-calc7b, cache=FALSE, echo=FALSE, warning=FALSE, error=FALSE, message=FALSE, fig.height=5, fig.width=5}
qplot(FL, RW, data=crab, color=sex, shape=sex) + ylim(c(2,22)) + xlim(c(2,22)) + 
  geom_abline(intercept=30, slope=-1.26, linetype=2) + 
  geom_abline(intercept=0.753, slope=0.795) + 
  theme(aspect.ratio=1) 
```

## Accuracy and Error

- Error from the model is the proportion of misclassified cases to toal number of cases. 
- It is important to look at this for each class also.
- Accuracy is 1-error

## Example: Crabs

```{r crab-error, cache=FALSE, echo=FALSE, warning=FALSE, error=FALSE, message=FALSE}
crab.lda <- lda(sex~FL+RW, data=crab, 
                 prior=c(0.5, 0.5))
table(crab$sex, predict(crab.lda, crab)$class)
```

- Overall error = 6/100 = 0.06
- Males = 5/50 = 0.10
- Females = 1/50 = 0.02

## Notes to self

- Give terminology difference between stats and data mining
- Add creative commons license

- to make plain markdown vs beamer formats needs ot switch html vs latex commands! will need two versions - yuck!